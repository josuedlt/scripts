<html ng-app='app'>

<head>
    <title>Deposit Bag Tracker</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no">
    <meta name="theme-color" content="#000000">

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/accounting.js/0.4.1/accounting.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-filter/0.5.17/angular-filter.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ngStorage/0.3.11/ngStorage.min.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://webservices.nisd.net/scripts/jquery.signalR-2.2.2.min.js"></script>
    <script type="text/javascript" src="../signalr/jdlt.signalRHubs.js"></script>

    <!-- Mapbox GL JS -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet' />

    <script src="angular-nisdAuthorization.js"></script>
    <script src="angular-nisdArmoredService.js"></script>
    <script src="angular-nisdMapbox.js"></script>

    <style>
        .fixed-top {
            position: absolute;
            top: 10;
            left: 10;
            right: 10;
            z-index: 9;
        }

        body {
            margin: 0;
        }

        dl dd {
            margin-left: 8;
            font-size: smaller;
        }

        .full-height {
            height: 100%;
        }
    </style>
</head>

<body>
    <auth-form class="fixed-top">
        <form name="authForm" ng-if="!$storage.auth" ng-submit="login({username, password})">
            <input type="text" name="username" ng-model="username">
            <input type="password" name="password" ng-model="password">
            <button type="submit">Submit</button>
        </form>
    </auth-form>

    <div ng-if="$storage.auth" armored-service>
        <auth-form class="fixed-top">
            <div style="float: right; text-align: right;">
                <button ng-click="logout()">Logout</button>
                <div>
                    <dl>
                        <dd ng-repeat-start='(key, bags) in collected | groupBy: "ReceiptedBy"'>{{key}}</dd>
                        <dt ng-repeat-end>
                            <small ng-bind="bags.length"></small>
                            <span ng-bind="sumBags(bags) | currency"></span>
                        </dt>
                    </dl>
                </div>
            </div>
            <button ng-click="fitBounds(locations)">Fit</button>
            <button ng-click="mapDrivers(connections)">Drivers</button>
            <button ng-click="mapDepositBags(locations, submitted)">Submitted</button>
            <button ng-click="mapDepositBags(locations, collected)">Collected</button>
            <input type="date" ng-model="collectedDate" ng-change="refresh()">
            <dl>
                <dt>Submitted:
                    <span ng-bind="submitted.length"></span>
                </dt>
                <dd ng-bind="(sumBags(submitted) | currency)"></dd>

                <dt>Collected:
                    <span ng-bind="collected.length"></span>
                </dt>
                <dd ng-bind="(sumBags(collected) | currency)"></dd>
            </dl>
        </auth-form>
        <div id="map" armored-service-map class="full-height"></div>
    </div>
</body>
<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoiam9zdWVkbHQiLCJhIjoiY2l5a3hwcGFzMDAxdjJ4czd0dW1nNnpvbiJ9.118F1NOgT72aFsmG99qPYQ';
    angular.module('app', ['angular.filter', 'ngStorage', 'nisdAuthorization', 'nisdArmoredService'])
        .directive('authForm', () => {
            return {
                controller: ($scope, LoginService) => {
                    $scope.login = LoginService.login;
                    $scope.logout = LoginService.logout;
                    $scope.getInfo = LoginService.getInfo;
                }
            }
        })
        .directive('armoredServiceMap', () => {
            return {
                link: (scope, elem, attrs) => {

                    var mapbox = scope.mapbox = new mapboxgl.Map({
                        container: elem[0],
                        style: 'mapbox://styles/mapbox/streets-v10/',
                        center: [-98.5, 29.43],
                        zoom: 10
                    });

                    // Load arrow image to indicate line direction
                    var url = 'https://image.flaticon.com/icons/png/128/25/25283.png';
                    mapbox.loadImage(url, function (err, image) {
                        if (err) return;
                        mapbox.addImage('arrow', image);
                    });

                    scope.mapSources = (sources) => {
                        sources.forEach((s) => {
                            if (!mapbox.getSource(s.id))
                                mapbox.addSource(s.id, {
                                    'type': 'geojson',
                                    'data': s.data
                                });
                            else
                                mapbox.getSource(s.id).setData(s.data);
                        })
                    }

                    scope.mapLayers = (layers) => {
                        layers.forEach((l) => {
                            if (!mapbox.getLayer(l.id))
                                mapbox.addLayer(l);
                        })
                    }

                    scope.fitBounds = (locations) => {
                        var latitudes = _.map(locations, 'Latitude');
                        var longitudes = _.map(locations, 'Longitude');
                        mapbox.fitBounds([
                            [_.min(longitudes), _.min(latitudes)],
                            [_.max(longitudes), _.max(latitudes)]
                        ], {
                                padding: 40
                            });
                    }

                    scope.mapDepositBags = (locations, submitted) => {
                        if (!locations) return;
                        var mapbox = scope.mapbox;

                        locations.forEach((l) => {
                            l.bags = submitted.filter((b) => b.Location == l.Code + ' ' + l.Name);
                            l.bagSum = scope.sumBags(l.bags);
                            l.bagAmount = accounting.formatMoney(scope.sumBags(l.bags));
                            l.bagGroup = (Math.ceil(l.bagSum / 1000));
                        });

                        var glSources = [{
                            'id': 'submitted',
                            'type': 'geojson',
                            'data': {
                                'type': 'FeatureCollection',
                                'features': _.map(locations, (l) => {
                                    return {
                                        'type': "Feature",
                                        'properties': {
                                            'bagCount': l.bags.length,
                                            'bagSum': l.bagSum,
                                            'bagGroup': l.bagGroup,
                                            'bagAmount': l.bagAmount,
                                            'title': l.Name
                                        },
                                        'geometry': {
                                            'type': "Point",
                                            'coordinates': [l.Longitude, l.Latitude]
                                        }
                                    }
                                })
                            }
                        }]

                        var groups = _.chain(locations)
                            .map('bagGroup')
                            .uniq()
                            .sortBy()
                            .filter(g => g > 0)
                            .value();

                        var glLayers = _.map(groups, (g) => {
                            return {
                                "id": 'submitted-' + g,
                                "type": 'symbol',
                                "source": 'submitted',
                                "filter": ["==", 'bagGroup', g],
                                "layout": {
                                    "text-anchor": "center",
                                    "text-field": "{bagAmount}",
                                    "text-offset": [0, 0],
                                    "text-size": 8 + (g / 2)
                                }
                            }
                        });

                        scope.mapSources(glSources);
                        scope.mapLayers(glLayers);

                    }

                    scope.mapRoutes = (locations, collected) => {
                        var mapbox = scope.mapbox;

                        var locations = _.map(locations, (l) => {
                            return {
                                Location: l.Code + ' ' + l.Name,
                                Position: [l.Longitude, l.Latitude]
                            }
                        });
                        var routes = _(collected)
                            .sortBy('ReceiptedDate')
                            .groupBy('ReceiptedBy')
                            .mapValues((v) => {
                                return _.map(_.uniq(_.map(v, 'Location')), (b) => _.find(locations, (l) => {
                                    return l.Location == b
                                }).Position);
                            })
                            .toPairs()
                            .value();

                        scope.mapSources([{
                            id: 'routes',
                            type: 'geojson',
                            data: {
                                type: 'FeatureCollection',
                                features: _.map(routes, r => ({
                                    type: 'Feature',
                                    geometry: {
                                        type: 'LineString',
                                        coordinates: r[1]
                                    },
                                    properties: {
                                        'driver': r[0],
                                    }
                                }))
                            }
                        }]);

                        scope.mapLayers(_.map(routes, r => ({
                            id: 'routes-' + r[0] + '-line',
                            type: 'line',
                            source: 'routes',
                            filter: ['==', 'driver', r[0]],
                            layout: {
                                'line-join': 'round',
                                'line-cap': 'round',
                            },
                            paint: {
                                'line-opacity': 0.5,
                                'line-width': 1
                            }
                        })));

                        scope.mapLayers(_.map(routes, r => ({
                            id: 'routes-' + r[0] + '-line-labels',
                            type: 'symbol',
                            source: 'routes',
                            filter: ['==', 'driver', r[0]],
                            layout: {
                                'symbol-placement': 'line',
                                'text-allow-overlap': true,
                                'text-field': '{driver}',
                                'text-size': 8,
                                'text-offset': [0, 1],
                            },
                            paint: {
                                'text-opacity': 0.7,
                            }
                        })));

                        scope.mapLayers(_.map(routes, r => ({
                            id: 'routes-' + r[0] + '-arrows',
                            type: 'symbol',
                            source: 'routes',
                            layout: {
                                'symbol-placement': 'line',
                                'symbol-spacing': 1,
                                'icon-allow-overlap': true,
                                'icon-image': 'arrow',
                                'icon-size': 0.06
                            },
                            paint: {
                                'icon-opacity': 0.3
                            }
                        })));
                    }

                    scope.mapDrivers = (connections) => {
                        var mapbox = scope.mapbox;

                        var glSources = [{
                            'id': 'collected',
                            'type': 'geojson',
                            'data': {
                                'type': 'FeatureCollection',
                                'features': _.map(_.filter(connections, 'Position'), (c) => {
                                    var name = c.RequestCookies.name;
                                    return {
                                        'type': "Feature",
                                        'properties': {
                                            'title': c.UserHostAddress,
                                            'address': (name) ? name.Value : 'Anonymous',
                                            'host': c.Headers.Host,
                                            'referer': c.Headers.Referer,
                                            'timestamp': c.Timestamp,
                                            'marker-symbol': 'car'
                                        },
                                        'geometry': {
                                            'type': "Point",
                                            'coordinates': [c.Position.Longitude, c.Position
                                                .Latitude
                                            ]
                                        }
                                    }
                                })
                            }
                        }]

                        var glLayers = [{
                            "id": 'collected-0',
                            "type": 'symbol',
                            "source": 'collected',
                            "layout": {
                                "icon-image": "{marker-symbol}-15",
                                "icon-allow-overlap": true,
                                "icon-size": 1,
                                "text-field": "{address}",
                                "text-allow-overlap": true,
                                "text-anchor": "center",
                                "text-size": 10,
                                "text-offset": [0, 1],
                            },
                            "paint": {
                                'icon-opacity': 0.8,
                                'text-opacity': 0.8
                            }
                        }]

                        scope.mapSources(glSources);
                        scope.mapLayers(glLayers);
                    }
                }
            }
        })
        .directive('armoredService', () => {
            return {
                controller: ($scope, ArmoredService, $location) => {

                    $scope.collectedDate = new Date;
                    $scope.sumBags = (bags) => {
                        return _.reduce(bags, (sum, bag) => {
                            return sum + accounting.parse(bag.TotalAmount);
                        }, 0)
                    }

                    ArmoredService.GetLocations().then((response) => {
                        $scope.locations = response.data;
                        $scope.fitBounds($scope.locations);
                    });

                    $scope.refresh = () => {
                        ArmoredService.GetSubmittedDepositBags().then((response) => {
                            $scope.submitted = response.data;
                            //$scope.mapDepositBags($scope.locations, $scope.submitted);
                        });

                        ArmoredService.GetCollectedDepositBags($scope.collectedDate).then((response) => {
                            $scope.collected = response.data;
                            $scope.mapRoutes($scope.locations, $scope.collected);
                            $scope.mapDepositBags($scope.locations, $scope.collected);
                        })
                    }

                    ArmoredService.SignalR.on('connections', (connections) => {
                        $scope.connections = connections.filter(c => c.Position != null);
                        //$scope.mapDrivers($scope.connections);
                    })

                    ArmoredService.SignalR.on('refresh', () => { refresh() });
                    $scope.refresh()
                }
            }
        })
</script>

</html>