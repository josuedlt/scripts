<html>

<head>
    <script src="../signalr/jquery.min.js"></script>
    <script src="../signalr/jquery.signalR-2.2.2.min.js"></script>
    <script src="../signalr/jdlt.signalRHubs.js"></script>
    <!-- AngularjJS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-moment/1.0.1/angular-moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ngStorage/0.3.11/ngStorage.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.0/lodash.min.js"></script>
</head>

<div ng-app="app">
    <p>
        <span ng-bind="state.name"></span>
        <span am-time-ago="state.date"></span><br />
        <small ng-bind="state.date | date: 'medium'"></small>
    </p>
    <p>
        synced data <span am-time-ago="refreshedOn"></span><br />
        <small ng-bind="refreshedOn | date: 'medium'"></small>
    </p>
    <pre ng-bind="connections | json"></pre>
</div>

<script>
    var hubConnection;
    var app = angular.module('app', ['angularMoment', 'ngStorage'])
        .run(function ($rootScope, $localStorage) {
            $rootScope.$storage = $localStorage;
            $rootScope.connections = $localStorage.connections;

            $rootScope.$watch('connections', function () {
                $rootScope.refreshedOn = new Date();
                //$rootScope.$apply();
            });

            signalR.connectToHub('https://webservices.nisd.net', function (hub) {
                hub.forceReconnect = signalR.forceReconnect(hub, function () {
                    console.log('Started!');
                }, 1).start();

                // State changed
                function doOnStateChanged() {
                    $rootScope.state = {
                        name: signalR.getStateName(hub.state),
                        date: new Date()
                    };
                    $rootScope.$apply();
                }
                doOnStateChanged();
                hub.logger = signalR.onStateChanged(hub, function () {
                    doOnStateChanged();
                })

                // Configure proxy client
                var proxy = hub.proxies.connectionshub;
                proxy.client = {
                    hasConnected: function (c) {
                        if (c.ConnectionId == hub.id) {
                            $rootScope.connections = [c];
                            $rootScope.id = hub.id;
                            proxy.server.getConnections().done(function (connections) {
                                $rootScope.connections = connections;
                                $rootScope.$apply();
                            });
                        } else {
                            var i = _.indexOf(_.map($rootScope.connections, 'ConnectionId'), c.ConnectionId)
                            if (i > -1) $rootScope.connections[i] = c;
                            else $rootScope.connections.push(c);
                        }
                        $rootScope.$apply();
                    },
                    hasDisconnected: function (c) {
                        if (c.ConnectionId == hub.id) {

                        } else {
                            var i = _.indexOf(_.map($rootScope.connections, 'ConnectionId'), c.ConnectionId);
                            if (i > -1) $rootScope.connections.splice(i, 1);
                            $rootScope.$apply();
                        }
                    },
                    hasUpdatedPosition: function (c, p) {
                        var i = _.indexOf(_.map($rootScope.connections, 'ConnectionId'), c.ConnectionId)
                        if (i > -1) $rootScope.connections[i].Position = p;
                        $rootScope.$apply();
                    }
                }

                hubConnection = hub;
            });
        })
</script>

</html>