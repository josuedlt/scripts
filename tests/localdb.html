<html>

<head>
    <script src="../signalr/jquery.min.js"></script>
    <script src="../signalr/jquery.signalR-2.2.2.min.js"></script>
    <script src="../signalr/jdlt.signalRHubs.js"></script>
    <!-- AngularjJS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-moment/1.0.1/angular-moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ngStorage/0.3.11/ngStorage.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.0/lodash.min.js"></script>
</head>

<div ng-app="app">
    <h3 ng-bind="state"></h3>
    <h4 am-time-ago="$storage.refreshedOn"></h4>
    <pre ng-bind="$storage.connections | json"></pre>
</div>

<script>
    var hubConnection;
    var app = angular.module('app', ['angularMoment', 'ngStorage'])
        .run(function ($rootScope, $localStorage) {
            $rootScope.$storage = $localStorage;
            $rootScope.connections = $localStorage.connections;

            $rootScope.$watch('connections', function () {
                $localStorage.connections = $rootScope.connections;
                $localStorage.refreshedOn = new Date();
            });

            signalR.connectToHub('https://webservices.nisd.net', function (hub) {
                var proxy = hub.proxies.connectionshub;
                //Connections Hub - Client
                proxy.client = {
                    hasConnected: function (c) {
                        if (c.ConnectionId == hub.id) {
                            $rootScope.connections = [c];
                            $rootScope.id = hub.id;
                            proxy.server.getConnections().done(function (connections) {
                                $rootScope.connections = connections;
                                $rootScope.$apply();
                            });
                        } else {
                            var i = _.indexOf(_.map($rootScope.connections, 'ConnectionId'), c.ConnectionId)
                            if (i > -1) $rootScope.connections[i] = c;
                            else $rootScope.connections.push(c);
                        }
                        $rootScope.$apply();
                    },
                    hasDisconnected: function (c) {
                        if (c.ConnectionId == hub.id) {

                        } else {
                            var i = _.indexOf(_.map($rootScope.connections, 'ConnectionId'), c.ConnectionId);
                            if (i > -1) $rootScope.connections.splice(i, 1);
                            $rootScope.$apply();
                        }
                    },
                    hasUpdatedPosition: function (c, p) {
                        var i = _.indexOf(_.map($rootScope.connections, 'ConnectionId'), c.ConnectionId)
                        if (i > -1) $rootScope.connections[i].Position = p;
                        $rootScope.$apply();
                    }
                }

                hub.forceReconnect = signalR.forceReconnect(hub, function() {
                    console.log('Started!');
                }, 1500).start();
                hub.logger = signalR.onStateChanged(hub, function (change) {
                    $rootScope.state = hub.logger.getState();
                    $rootScope.$apply();
                })
                $rootScope.state = hub.logger.getState();
                $rootScope.$apply();

                hubConnection = hub;
            });
        })
</script>

</html>