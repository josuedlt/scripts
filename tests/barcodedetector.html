<html>

<head>
    <title>Barcode Detector</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
    <meta name="theme-color" content="#FFCC00">

    <link href="https://jenil.github.io/bulmaswatch/darkly/bulmaswatch.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue"></script>

</head>

<style>
    img,
    video {
        border: solid thin #ccc;
    }
</style>

<body>
    <div class="content" id="app">
        <table width="100%">
            <tr>
                <td width="50%">
                    <video id="video"></video>
                </td>
                <td width="50%">
                    <img id="img">
                    <img id="barcodesImage">
                </td>
            </tr>
        </table>

        <pre>{{ (barcodes) ? JSON.stringify(barcodes,null,2) : 'Scan a barcode'}}</pre>
    </div>
</body>

<script>
    var app = new Vue({
        el: '#app',
        data: {
            barcodes: {},
        },
        methods: {
            frameToCanvas: (video) => {
                var canvas = document.createElement('canvas')
                canvas.height = video.videoHeight
                canvas.width = video.videoWidth
                canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight)
                return canvas
            },
            imageToCanvas: (image) => {
                var canvas = document.createElement('canvas')
                canvas.height = image.imageHeight
                canvas.width = image.imageWidth
                canvas.getContext('2d').drawImage(image, 0, 0, image.imageWidth, image.imageHeight)
                return canvas
            },
            pointsToCanvas: (canvas, barcodes) => {
                var ctx = canvas.getContext('2d')
                barcodes.forEach(barcode => {
                    var points = barcode.cornerPoints.map(i => [Math.round(i.x), Math.round(i.y)])
                    ctx.lineWidth = "5"
                    ctx.strokeStyle = 'rgba(0,255,0,0.5)';
                    ctx.beginPath()
                    points.forEach(p => ctx.lineTo(p[0], p[1]))
                    ctx.lineTo(points[0][0], points[0][1])
                    ctx.stroke()
                })
                return canvas
            }
        },
        created() {
            BarcodeDetector.getSupportedFormats()
                .then(formats => {
                    if (formats.length == 0) {
                        alert('Barcode detector not supported.');
                        return;
                    }

                    var barcodeDetector = new BarcodeDetector(formats)
                    navigator.mediaDevices
                        .getUserMedia({ video: { facingMode: 'environment' } })
                        .then(stream => {
                            var video = document.getElementById('video')
                            video.srcObject = stream
                            video.play()

                            setInterval(() => {
                                var img = this.frameToCanvas(video)
                                barcodeDetector.detect(img)
                                    .then(barcodes => {
                                        if (barcodes.length > 0) {
                                            this.barcodes = barcodes.map(b => ({ format: b.format, value: b.rawValue }))
                                            var barcodesImage = document.getElementById('barcodesImage')
                                            barcodesImage.src = this.pointsToCanvas(img, barcodes).toDataURL()
                                        }
                                    })

                            }, 200)
                        })


                })
        }
    })
</script>

</html>